# Event-Viewing
## Category: Medium, Forensics, picoCTF 2025, browser_webshell_solveable
### Author: Venax

### Description
One of the employees at your company has their computer infected by malware! Turns out every time they try to switch on the computer, it shuts down right after they log in. The story given by the employee is as follows:
1. They installed software using an installer they downloaded online
2. They ran the installed software but it seemed to do nothing
3. Now every time they bootup and login to their computer, a black command prompt screen quickly opens and closes and their computer shuts down instantly.

See if you can find evidence for the each of these events and retrieve the flag (split into 3 pieces) from the correct logs!
Download the Windows Log file <a href="https://challenge-files.picoctf.net/c_verbal_sleep/123d9b79cadb6b44ab6ae912f25bf9cc18498e8addee851e7d349416c7ffc1e1/Windows_Logs.evtx">here</a>

### Write-Up
Jadi di sini kita diberikan sebuah file event log dari MS windows. Dari deskripsinya sendiri kita bisa mengikuti hint yang sudah diberikan, yaitu ada 3 kejadian penting yang dialami pegawai di chall ini. Dalam kasusnya pegawai di sini menginstall sebuah
software secara online yang kemungkinan adalah malware. Lalu menjalankannya, tapi tidak ada proses yang terlihat dengan mata secara langsung dan setiap dia booting dan login maka ada sebuah cmd yang muncul. 

```
└─$ file Windows_Logs.evtx 
Windows_Logs.evtx: MS Windows 10-11 Event Log, version  3.2, 99 chunks (no. 98 in use), next record no. 8620
```

Di sini aku menggunakan tools buatan EricZimmerman karena aku dalam env linux dan ingin mencoba menganalisis log event ini di linux.

```
└─$ evtxecmd -f ./Windows_Logs.evtx \
--csv . \
> --csvf "chall.csv"
EvtxECmd version 1.5.2.0

Author: Eric Zimmerman (saericzimmerman@gmail.com)
https://github.com/EricZimmerman/evtx

Command line: -f ./Windows_Logs.evtx --csv . --csvf chall.csv

CSV output will be saved to ./chall.csv
```
Setelah di extract seakrang aku punya chall.csv, tapi jika dicek isinya, masih banyak dan ada ribuan log event di dalamnya jadi aku perlu filtering ke beberapa event yang penting saja dengan script python yang ada di repository ini.

```
└─$ python3 extractor.py 
[*] Membaca file dari: /tmp/chall.csv...
[*] Menulis header dan mengekstrak data...
[+] Selesai! 8619 baris data berhasil diekstrak ke /tmp/filtered_chall.csv
```

Setelah selsai, aku coba buka dan aku langsung cek kolom ExecutableInfo untuk Exe suatu browser. Aku menemukan 1 browser yang sering dipakai di log ini yaitu msedge.exe dan bagian menarik pertama ada di sini, yaitu ada yang menarik di bagian map description. Ini adalah log awal ketika pekerja menginstall aplikasinya melalui explorer
dan pada PayloadData1 kita bisa melihat ada sebuah encoded base 64 yang jika di decode akan menjadi potongan flag pertama: **picoCTF{Ev3nt_vi3wv3r_**, sekarang kita hanya perlu mencari lagi kejadian selanjutnya yaitu ketika aplikasi yang diinstall dijalankan. Jika dilihat, nama aplikasinya adalah **Totally_Legit_Software**

```
	2370	2024-07-15 15:55:55.9707879	1040	Info	MsiInstaller	Application	0	0	DESKTOP-EKVR84B	0	S-1-5-21-3576963320-1344788273-4164204335-1001	Installer Started									C:\Users\user\Desktop\Totally_Legit_Software.msi	FALSE	/tmp/Windows_Logs.evtx	0x80000000000000	0	{"EventData":{"Data":"C:\\Users\\user\\Desktop\\Totally_Legit_Software.msi, 9004, (NULL), (NULL), (NULL), (NULL)","Binary":""}}		
	2371	2024-07-15 15:55:57.7297984	1042	Info	MsiInstaller	Application	0	0	DESKTOP-EKVR84B	0	S-1-5-18	Installer Exited									C:\Users\user\Desktop\Totally_Legit_Software.msi	FALSE	/tmp/Windows_Logs.evtx	0x80000000000000	0	{"EventData":{"Data":"C:\\Users\\user\\Desktop\\Totally_Legit_Software.msi, 9004, (NULL), (NULL), (NULL), (NULL)","Binary":""}}		
	2372	2024-07-15 15:55:57.7297984	11707	Info	MsiInstaller	Application	0	0	DESKTOP-EKVR84B	0	S-1-5-21-3576963320-1344788273-4164204335-1001	Installation completed successfully			Product: Totally_Legit_Software -- Installation completed successfully., (NULL), (NULL), (NULL), (NULL), (NULL)							FALSE	/tmp/Windows_Logs.evtx	0x80000000000000	0	{"EventData":{"Data":"Product: Totally_Legit_Software -- Installation completed successfully., (NULL), (NULL), (NULL), (NULL), (NULL)","Binary":"7B-33-44-33-43-33-38-33-33-2D-44-45-44-36-2D-34-30-32-32-2D-42-35-41-31-2D-45-37-46-33-37-37-38-39-43-33-39-30-7D"}}		
	2373	2024-07-15 15:55:57.7297984	1033	Info	MsiInstaller	Application	0	0	DESKTOP-EKVR84B	0	S-1-5-21-3576963320-1344788273-4164204335-1001	A program was installed			Name, Version, Lang, Status, Manufacturer: Totally_Legit_Software, 1.3.3.7, 0, 0, cGljb0NURntFdjNudF92aTN3djNyXw==, (NULL)							FALSE	/tmp/Windows_Logs.evtx	0x80000000000000	0	{"EventData":{"Data":"Totally_Legit_Software, 1.3.3.7, 0, 0, cGljb0NURntFdjNudF92aTN3djNyXw==, (NULL)","Binary":"7B-33-44-33-43-33-38-33-33-2D-44-45-44-36-2D-34-30-32-32-2D-42-35-41-31-2D-45-37-46-33-37-37-38-39-43-33-39-30-7D-30-30-30-30-37-36-35-33-37-62-39-37-30-32-33-39-66-39-61-30-37-35-30-63-34-31-62-38-38-36-34-66-64-61-63-39-30-30-30-30-30-30-30-30"}}		
	2374	2024-07-15 15:55:57.3037587	10000	Info	Microsoft-Windows-RestartManager	Application	8200	9012	DESKTOP-EKVR84B	0	S-1-5-21-3576963320-1344788273-4164204335-1001											FALSE	/tmp/Windows_Logs.evtx	Classic	0	{"UserData":{"RmSessionEvent":{"RmSessionId":"0","UTCStartTime":"2024-07-15 15:55:57.2923794"}}}		
	2375	2024-07-15 15:55:57.7186998	10001	Info	Microsoft-Windows-RestartManager	Application	8200	7028	DESKTOP-EKVR84B	0	S-1-5-21-3576963320-1344788273-4164204335-1001											FALSE	/tmp/Windows_Logs.evtx	Classic	0	{"UserData":{"RmSessionEvent":{"RmSessionId":"0","UTCStartTime":"2024-07-15 15:55:57.2923794"}}}		
```

Kita trace lewat executable info, dari situ kita tahu kalau malware ini sekarang ada di path **C:\Program Files (x86)\Totally_Legit_Software\Totally_Legit_Software.exe**. Jika dicek, aplikasi ini menambahkan jalur value baru ke jalur **\REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run**, yang mana kunci registry run sendiri digunakan untuk otomatis menjalankan program yang di letakkan disitu untuk dijalankan setiap komputer dinyalakan. 
Dalam kasus ini jika kita cek payload data 6 adalah **New type \ value: %%1873 \ C:\Program Files (x86)\Totally_Legit_Software\custom_shutdown.exe**  yaitu custom_shutdown.exe, yang menjelaskan deskripsi hint point 3 tentang kejadian tiap user melakukan booting pada pc dan login. Di payload data 4 kita bisa menemukan potongan flag kedua yang jika di decode hasilnya: **1s_a_pr3tty_us3ful_**

```
	168649	2024-07-15 15:56:18.7007382	4658	LogAlways	Microsoft-Windows-Security-Auditing	Security	4	6676	DESKTOP-EKVR84B	1		The handle to an object was closed	DESKTOP-EKVR84B\user		SID: S-1-5-21-3576963320-1344788273-4164204335-1001	ObjectServer: Security	HandleId: 0x3ED8				C:\Program Files (x86)\Totally_Legit_Software\Totally_Legit_Software.exe (PID: 0xC54)	FALSE	/tmp/Windows_Logs.evtx	Audit success	0	{"EventData":{"Data":[{"@Name":"SubjectUserSid","#text":"S-1-5-21-3576963320-1344788273-4164204335-1001"},{"@Name":"SubjectUserName","#text":"user"},{"@Name":"SubjectDomainName","#text":"DESKTOP-EKVR84B"},{"@Name":"SubjectLogonId","#text":"0x5A45F"},{"@Name":"ObjectServer","#text":"Security"},{"@Name":"HandleId","#text":"0x3ED8"},{"@Name":"ProcessId","#text":"0xC54"},{"@Name":"ProcessName","#text":"C:\\Program Files (x86)\\Totally_Legit_Software\\Totally_Legit_Software.exe"}]}}		
	168650	2024-07-15 15:56:18.7007818	4656	LogAlways	Microsoft-Windows-Security-Auditing	Security	4	6676	DESKTOP-EKVR84B	1		A handle to an object was requested	DESKTOP-EKVR84B\user		ObjectType: File	ObjectName: C:\Windows\WinSxS\FileMaps\_0000000000000000.cdf-ms	HandleId: 0x4C8	TransactionId: 00000000-0000-0000-0000-000000000000	AccessList: Unknown code (%%1538, %%1541, %%4416, %%4419, %%4423, )	PrivilegeList: -	C:\Program Files (x86)\Totally_Legit_Software\Totally_Legit_Software.exe (PID: 0xC54)	FALSE	/tmp/Windows_Logs.evtx	Audit success	0	{"EventData":{"Data":[{"@Name":"SubjectUserSid","#text":"S-1-5-21-3576963320-1344788273-4164204335-1001"},{"@Name":"SubjectUserName","#text":"user"},{"@Name":"SubjectDomainName","#text":"DESKTOP-EKVR84B"},{"@Name":"SubjectLogonId","#text":"0x5A45F"},{"@Name":"ObjectServer","#text":"Security"},{"@Name":"ObjectType","#text":"File"},{"@Name":"ObjectName","#text":"C:\\Windows\\WinSxS\\FileMaps\\_0000000000000000.cdf-ms"},{"@Name":"HandleId","#text":"0x4C8"},{"@Name":"TransactionId","#text":"00000000-0000-0000-0000-000000000000"},{"@Name":"AccessList","#text":"%%1538, %%1541, %%4416, %%4419, %%4423, "},{"@Name":"AccessReason","#text":"%%1538:, %%1801, D:(A;;0x1200a9;;;BU), %%1541:, %%1801, D:(A;;0x1200a9;;;BU), %%4416:, %%1801, D:(A;;0x1200a9;;;BU), %%4419:, %%1801, D:(A;;0x1200a9;;;BU), %%4423:, %%1801, D:(A;;0x1200a9;;;BU), "},{"@Name":"AccessMask","#text":"0x120089"},{"@Name":"PrivilegeList","#text":"-"},{"@Name":"RestrictedSidCount","#text":"0"},{"@Name":"ProcessId","#text":"0xC54"},{"@Name":"ProcessName","#text":"C:\\Program Files (x86)\\Totally_Legit_Software\\Totally_Legit_Software.exe"},{"@Name":"ResourceAttributes","#text":"-"}]}}		
	168651	2024-07-15 15:56:18.7008657	4658	LogAlways	Microsoft-Windows-Security-Auditing	Security	4	6676	DESKTOP-EKVR84B	1		The handle to an object was closed	DESKTOP-EKVR84B\user		SID: S-1-5-21-3576963320-1344788273-4164204335-1001	ObjectServer: Security	HandleId: 0x4C8				C:\Program Files (x86)\Totally_Legit_Software\Totally_Legit_Software.exe (PID: 0xC54)	FALSE	/tmp/Windows_Logs.evtx	Audit success	0	{"EventData":{"Data":[{"@Name":"SubjectUserSid","#text":"S-1-5-21-3576963320-1344788273-4164204335-1001"},{"@Name":"SubjectUserName","#text":"user"},{"@Name":"SubjectDomainName","#text":"DESKTOP-EKVR84B"},{"@Name":"SubjectLogonId","#text":"0x5A45F"},{"@Name":"ObjectServer","#text":"Security"},{"@Name":"HandleId","#text":"0x4C8"},{"@Name":"ProcessId","#text":"0xC54"},{"@Name":"ProcessName","#text":"C:\\Program Files (x86)\\Totally_Legit_Software\\Totally_Legit_Software.exe"}]}}		
	168652	2024-07-15 15:56:19.1027989	4690	LogAlways	Microsoft-Windows-Security-Auditing	Security	4	1084	DESKTOP-EKVR84B	1												FALSE	/tmp/Windows_Logs.evtx	Audit success	0	{"EventData":{"Data":[{"@Name":"SubjectUserSid","#text":"S-1-5-21-3576963320-1344788273-4164204335-1001"},{"@Name":"SubjectUserName","#text":"user"},{"@Name":"SubjectDomainName","#text":"DESKTOP-EKVR84B"},{"@Name":"SubjectLogonId","#text":"0x5A428"},{"@Name":"SourceHandleId","#text":"0x208"},{"@Name":"SourceProcessId","#text":"0x1BD0"},{"@Name":"TargetHandleId","#text":"0x3C44"},{"@Name":"TargetProcessId","#text":"0x4"}]}}		
	168653	2024-07-15 15:56:19.1028117	4658	LogAlways	Microsoft-Windows-Security-Auditing	Security	4	1084	DESKTOP-EKVR84B	1		The handle to an object was closed	DESKTOP-EKVR84B\user		SID: S-1-5-21-3576963320-1344788273-4164204335-1001	ObjectServer: Security	HandleId: 0x3C44				C:\Program Files (x86)\Totally_Legit_Software\Totally_Legit_Software.exe (PID: 0x1BD0)	FALSE	/tmp/Windows_Logs.evtx	Audit success	0	{"EventData":{"Data":[{"@Name":"SubjectUserSid","#text":"S-1-5-21-3576963320-1344788273-4164204335-1001"},{"@Name":"SubjectUserName","#text":"user"},{"@Name":"SubjectDomainName","#text":"DESKTOP-EKVR84B"},{"@Name":"SubjectLogonId","#text":"0x5A428"},{"@Name":"ObjectServer","#text":"Security"},{"@Name":"HandleId","#text":"0x3C44"},{"@Name":"ProcessId","#text":"0x1BD0"},{"@Name":"ProcessName","#text":"C:\\Program Files (x86)\\Totally_Legit_Software\\Totally_Legit_Software.exe"}]}}		
	168654	2024-07-15 15:56:19.1028269	4656	LogAlways	Microsoft-Windows-Security-Auditing	Security	4	1084	DESKTOP-EKVR84B	1		A handle to an object was requested	DESKTOP-EKVR84B\user		ObjectType: Key	ObjectName: \REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run	HandleId: 0x208	TransactionId: 00000000-0000-0000-0000-000000000000	AccessList: Unknown code (%%4433, )	PrivilegeList: -	C:\Program Files (x86)\Totally_Legit_Software\Totally_Legit_Software.exe (PID: 0x1BD0)	FALSE	/tmp/Windows_Logs.evtx	Audit success	0	{"EventData":{"Data":[{"@Name":"SubjectUserSid","#text":"S-1-5-21-3576963320-1344788273-4164204335-1001"},{"@Name":"SubjectUserName","#text":"user"},{"@Name":"SubjectDomainName","#text":"DESKTOP-EKVR84B"},{"@Name":"SubjectLogonId","#text":"0x5A428"},{"@Name":"ObjectServer","#text":"Security"},{"@Name":"ObjectType","#text":"Key"},{"@Name":"ObjectName","#text":"\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"},{"@Name":"HandleId","#text":"0x208"},{"@Name":"TransactionId","#text":"00000000-0000-0000-0000-000000000000"},{"@Name":"AccessList","#text":"%%4433, "},{"@Name":"AccessReason","#text":"-"},{"@Name":"AccessMask","#text":"0x2"},{"@Name":"PrivilegeList","#text":"-"},{"@Name":"RestrictedSidCount","#text":"0"},{"@Name":"ProcessId","#text":"0x1BD0"},{"@Name":"ProcessName","#text":"C:\\Program Files (x86)\\Totally_Legit_Software\\Totally_Legit_Software.exe"},{"@Name":"ResourceAttributes","#text":"-"}]}}		
	168655	2024-07-15 15:56:19.1028356	4663	LogAlways	Microsoft-Windows-Security-Auditing	Security	4	1084	DESKTOP-EKVR84B	1		Attempt was made to access an object	DESKTOP-EKVR84B\user		ObjectServer: Security	ObjectType: Key	ObjectName: \REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run	AccessList: Unknown code (%%4433, )			C:\Program Files (x86)\Totally_Legit_Software\Totally_Legit_Software.exe	FALSE	/tmp/Windows_Logs.evtx	Audit success	0	{"EventData":{"Data":[{"@Name":"SubjectUserSid","#text":"S-1-5-21-3576963320-1344788273-4164204335-1001"},{"@Name":"SubjectUserName","#text":"user"},{"@Name":"SubjectDomainName","#text":"DESKTOP-EKVR84B"},{"@Name":"SubjectLogonId","#text":"0x5A428"},{"@Name":"ObjectServer","#text":"Security"},{"@Name":"ObjectType","#text":"Key"},{"@Name":"ObjectName","#text":"\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"},{"@Name":"HandleId","#text":"0x208"},{"@Name":"AccessList","#text":"%%4433, "},{"@Name":"AccessMask","#text":"0x2"},{"@Name":"ProcessId","#text":"0x1BD0"},{"@Name":"ProcessName","#text":"C:\\Program Files (x86)\\Totally_Legit_Software\\Totally_Legit_Software.exe"},{"@Name":"ResourceAttributes","#text":"-"}]}}		
	168656	2024-07-15 15:56:19.1031964	4657	LogAlways	Microsoft-Windows-Security-Auditing	Security	4	1084	DESKTOP-EKVR84B	2		A registry value was modified	DESKTOP-EKVR84B\user		Logon ID: 0x5A428	Operation Type: %%1904	Registry Key: \REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run	Value Name: Immediate Shutdown (MXNfYV9wcjN0dHlfdXMzZnVsXw==)	Old type \ value: - \ -	New type \ value: %%1873 \ C:\Program Files (x86)\Totally_Legit_Software\custom_shutdown.exe	C:\Program Files (x86)\Totally_Legit_Software\Totally_Legit_Software.exe (PID: 0x1BD0)	FALSE	/tmp/Windows_Logs.evtx	Audit success	0	{"EventData":{"Data":[{"@Name":"SubjectUserSid","#text":"S-1-5-21-3576963320-1344788273-4164204335-1001"},{"@Name":"SubjectUserName","#text":"user"},{"@Name":"SubjectDomainName","#text":"DESKTOP-EKVR84B"},{"@Name":"SubjectLogonId","#text":"0x5A428"},{"@Name":"ObjectName","#text":"\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"},{"@Name":"ObjectValueName","#text":"Immediate Shutdown (MXNfYV9wcjN0dHlfdXMzZnVsXw==)"},{"@Name":"HandleId","#text":"0x208"},{"@Name":"OperationType","#text":"%%1904"},{"@Name":"OldValueType","#text":"-"},{"@Name":"OldValue","#text":"-"},{"@Name":"NewValueType","#text":"%%1873"},{"@Name":"NewValue","#text":"C:\\Program Files (x86)\\Totally_Legit_Software\\custom_shutdown.exe"},{"@Name":"ProcessId","#text":"0x1BD0"},{"@Name":"ProcessName","#text":"C:\\Program Files (x86)\\Totally_Legit_Software\\Totally_Legit_Software.exe"}]}}		
	168657	2024-07-15 15:56:19.1032356	4658	LogAlways	Microsoft-Windows-Security-Auditing	Security	4	1084	DESKTOP-EKVR84B	2		The handle to an object was closed	DESKTOP-EKVR84B\user		SID: S-1-5-21-3576963320-1344788273-4164204335-1001	ObjectServer: Security	HandleId: 0x208				C:\Program Files (x86)\Totally_Legit_Software\Totally_Legit_Software.exe (PID: 0x1BD0)	FALSE	/tmp/Windows_Logs.evtx	Audit success	0	{"EventData":{"Data":[{"@Name":"SubjectUserSid","#text":"S-1-5-21-3576963320-1344788273-4164204335-1001"},{"@Name":"SubjectUserName","#text":"user"},{"@Name":"SubjectDomainName","#text":"DESKTOP-EKVR84B"},{"@Name":"SubjectLogonId","#text":"0x5A428"},{"@Name":"ObjectServer","#text":"Security"},{"@Name":"HandleId","#text":"0x208"},{"@Name":"ProcessId","#text":"0x1BD0"},{"@Name":"ProcessName","#text":"C:\\Program Files (x86)\\Totally_Legit_Software\\Totally_Legit_Software.exe"}]}}		
```

Sekarang kita perlu mencari key word shutdown di pencarian untuk cek kemungkinan potongan flag terakhir. Di sini aku menemukan di timestamp 2024-07-15 17:01:05.3935836 dengan provider user32 dan channel system yang di kolom ExecutableInfonya ada sebuah aplikasi shutdown.exe, menjelaskan tentang device user yang melakukan shutdown secara instan. Di sini aku tidak menemukan potongan flag pada PayloadInfo seperti sebelumnya, tapi pada kolom payload full nya di bagian akhir, kita bisa menemukan potongan flag yang di encode: dDAwbF84MWJhM2ZlOX0=. Jika di decode hasilnya **t00l_81ba3fe9}**

```
	3801	2024-07-15 17:01:05.3935836	1074	Info	User32	System	432	3496	DESKTOP-EKVR84B	64	S-1-5-21-3576963320-1344788273-4164204335-1001	A user initiated a system restart	DESKTOP-EKVR84B\user		Hostname: DESKTOP-EKVR84B	Reason: No title for this reason could be found	Type: shutdown	Code: 0x800000ff			C:\Windows\system32\shutdown.exe (DESKTOP-EKVR84B)	FALSE	/tmp/Windows_Logs.evtx	Audit success, classic	0	{"EventData":{"Data":[{"@Name":"param1","#text":"C:\\Windows\\system32\\shutdown.exe (DESKTOP-EKVR84B)"},{"@Name":"param2","#text":"DESKTOP-EKVR84B"},{"@Name":"param3","#text":"No title for this reason could be found"},{"@Name":"param4","#text":"0x800000ff"},{"@Name":"param5","#text":"shutdown"},{"@Name":"param6","#text":"dDAwbF84MWJhM2ZlOX0="},{"@Name":"param7","#text":"DESKTOP-EKVR84B\\user"}]}}		
```

**Flag: picoCTF{Ev3nt_vi3wv3r_1s_a_pr3tty_us3ful_t00l_81ba3fe9}**
